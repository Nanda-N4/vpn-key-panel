<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title><%= panelConfig?.brandName || "VPN KEY" %></title>

  <link rel="stylesheet" href="/public/00-tokens.css" />
  <link rel="stylesheet" href="/public/01-base.css" />
  <link rel="stylesheet" href="/public/02-layout.css" />
  <link rel="stylesheet" href="/public/03-components.css" />
  <link rel="stylesheet" href="/public/04-pages.css" />
  <link rel="stylesheet" href="/public/05-utilities.css" />
</head>

<body>
<div class="bg-aurora" aria-hidden="true"></div>

<%
  function safeStr(v){ return (v ?? "").toString().trim(); }

  function formatExpire(dateStr){
    const s = safeStr(dateStr);
    if(!s) return { iso: "-", human: "-", mm: "-" };

    // Expect YYYY-MM-DD
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if(!m) return { iso: s, human: s, mm: s };

    const yyyy = Number(m[1]);
    const mm = Number(m[2]);
    const dd = Number(m[3]);

    const monthsEn = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const monthsMm = ["·Äá·Äî·Ä∫·Äî·Äù·Ä´·Äõ·ÄÆ","·Äñ·Ä±·Äñ·Ä±·Ä¨·Ä∫·Äù·Ä´·Äõ·ÄÆ","·Äô·Äê·Ä∫","·Äß·Äï·Äº·ÄÆ","·Äô·Ä±","·Äá·ÄΩ·Äî·Ä∫","·Äá·Ä∞·Äú·Ä≠·ÄØ·ÄÑ·Ä∫","·Äû·Äº·ÄÇ·ÄØ·Äê·Ä∫","·ÄÖ·ÄÄ·Ä∫·Äê·ÄÑ·Ä∫·Äò·Ä¨","·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äê·Ä≠·ÄØ·Äò·Ä¨","·Äî·Ä≠·ÄØ·Äù·ÄÑ·Ä∫·Äò·Ä¨","·Äí·ÄÆ·Äá·ÄÑ·Ä∫·Äò·Ä¨"];

    const human = `${dd} ${monthsEn[mm-1]} ${yyyy}`;
    const mmText = `${yyyy} ·ÄÅ·ÄØ·Äî·Äæ·ÄÖ·Ä∫ ${monthsMm[mm-1]}·Äú ${dd} ·Äõ·ÄÄ·Ä∫`;

    return { iso: s, human, mm: mmText };
  }

  const gb = Number(item?.gb_limit || 0) || 0;
  const exp = formatExpire(item?.expire_date || "");
%>

<div class="app-shell">

  <!-- HEADER (N4 style) -->
  <header class="app-header glass">
    <div class="container header-inner">

      <div class="brand">
        <img src="/public/images/n4logo.png" alt="N4 Logo" class="logo-img">
        <div class="brand-title">N4 VPN</div>
      </div>

      <% if (panelConfig?.telegramChannelUrl) { %>
        <a class="pill glass-btn small"
           href="<%= panelConfig.telegramChannelUrl %>"
           target="_blank"
           rel="noopener">
           üì¢ Join Channel
        </a>
      <% } %>

    </div>
  </header>

  <main class="container main">

    <div class="top-row">
      <a class="pill glass-btn" href="/">‚Üê Back</a>
    </div>

    <% if (error) { %>
      <section class="card glass" style="padding:16px;">
        <h2 style="margin:0 0 8px 0;">Error</h2>
        <p style="margin:0;"><%= error %></p>
      </section>
    <% } %>

    <% if (item) { %>
      <section class="card glass detail-card">

        <!-- Header / Summary -->
        <div class="detail-head" style="gap:12px;">

          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div class="status-pill <%= (item.statusComputed || '').toLowerCase() %>">
              <%= (item.statusComputed || '').toUpperCase() %>
            </div>

            <div style="opacity:.75; font-weight:700;">
              ID #<%= item.id %>
            </div>
          </div>

          <h2 class="detail-title" style="margin:0; font-size:34px; letter-spacing:-.4px;">
            <%= (item.type || '').toUpperCase() %>
          </h2>

          <div class="detail-region" style="font-size:18px;">
            <span class="flag"><%= item.region_flag || "üåç" %></span>
            <span style="font-weight:800;"><%= item.region_name || "Unknown" %></span>
          </div>

          <!-- Info pills -->
          <div class="key-meta" style="margin-top:4px;">
            <span class="dot">
              <span style="font-weight:900;">GB</span>
              <span style="font-weight:900; margin-left:6px;"><%= gb %></span>
            </span>
            <span class="dot">
              <span style="font-weight:900;">Expire</span>
              <span style="font-weight:900; margin-left:6px;"><%= exp.human %></span>
            </span>
          </div>

          <!-- Info text (clean + clear) -->
          <div class="muted" style="margin-top:6px; line-height:1.55;">
            ·Äí·ÄÆ Key ·ÄÄ <span style="font-weight:900; opacity:1;"><%= gb %> GB</span> ·Ä°·Äë·Ä≠ ·Äû·ÄØ·Ä∂·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã
            <br/>
            ·Äû·ÄÄ·Ä∫·Äê·Äô·Ä∫·Ä∏·ÄÄ·ÄØ·Äî·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äõ·ÄÄ·Ä∫ ‚Äî <span style="font-weight:900; opacity:1;"><%= exp.mm %></span>
          </div>

        </div>

        <!-- KEY (make it visible & clean) -->
        <div class="key-box" style="margin-top:16px;">
          <div class="key-label" style="font-weight:900; letter-spacing:.2px;">Key</div>

          <div class="key-row" style="margin-top:10px; align-items:stretch;">
            <input
              id="keyInput"
              class="input key-input"
              readonly
              value="<%= item.key_string || '' %>"
              style="font-weight:800; letter-spacing:.2px;"
            />
            <button class="btn glass-btn" type="button" onclick="copyKey()" style="white-space:nowrap;">
              üìã Copy
            </button>
          </div>

          <div class="muted" style="margin-top:10px;">
            Copy ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Äû·ÄØ·Ä∂·Ä∏·Äô·Äö·Ä∑·Ä∫ App ·Äë·Ä≤·Äô·Äæ·Ä¨ Import / Paste ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ Connect ·Äú·ÄØ·Äï·Ä∫·Äï·Ä´·Åã
          </div>
        </div>

        <!-- DOWNLOAD APPS -->
        <div class="apps" style="margin-top:18px;">
          <div class="apps-title" style="font-weight:900;">Download Apps</div>

          <div class="apps-grid apps-grid-cards" style="margin-top:10px;">
            <% (apps || []).forEach(a => { %>
              <a class="app-item glass app-platform <%= a.icon %>"
                 href="<%= a.url %>" target="_blank" rel="noopener">

                <div class="app-left" style="display:flex; align-items:center; gap:12px;">

                  <% if (a.icon === "windows") { %>
                    <svg viewBox="0 0 24 24" class="app-icon" aria-hidden="true" style="width:22px; height:22px;">
                      <path fill="currentColor"
                        d="M3 4l8-1v9H3V4zm0 16l8 1v-9H3v8zm10-17l8-1v10h-8V3zm0 18l8 1v-9h-8v8z"/>
                    </svg>
                  <% } else if (a.icon === "apple") { %>
                    <svg viewBox="0 0 24 24" class="app-icon" aria-hidden="true" style="width:22px; height:22px;">
                      <path fill="currentColor"
                        d="M16.365 1.43c0 1.14-.48 2.21-1.25 2.97-.78.77-1.84 1.25-3 1.25-.08-1.14.45-2.32 1.23-3.09C14.1 1.8 15.19 1.37 16.36 1.43zM20.9 17.6c-.4.9-.9 1.7-1.5 2.4-.9 1-1.8 2-3.3 2-1.4 0-1.8-.9-3.4-.9s-2 .9-3.4.9c-1.5 0-2.5-1-3.4-2-1.7-1.9-3-5.2-3-8.1 0-2.8 1.8-4.3 3.5-4.3 1.4 0 2.6 1 3.4 1s2.3-1.2 3.9-1c.7 0 2.7.3 4 2.1-3.5 1.9-2.9 6.9 1.2 8z"/>
                    </svg>
                  <% } else if (a.icon === "android") { %>
                    <svg viewBox="0 0 24 24" class="app-icon" aria-hidden="true" style="width:22px; height:22px;">
                      <path fill="currentColor"
                        d="M7 9h10v8H7zM9 4l1-2h4l1 2M8 9V7h8v2M6 9h2v8H6M16 9h2v8h-2"/>
                    </svg>
                  <% } else { %>
                    <svg viewBox="0 0 24 24" class="app-icon" aria-hidden="true" style="width:22px; height:22px;">
                      <path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/>
                    </svg>
                  <% } %>

                  <div>
                    <div class="app-name" style="font-weight:900;"><%= a.name %></div>
                    <div class="app-sub" style="opacity:.8;"><%= a.sub %></div>
                  </div>
                </div>

                <div class="app-arrow" aria-hidden="true" style="opacity:.8;">
                  <svg viewBox="0 0 24 24" width="18" height="18">
                    <path fill="currentColor"
                      d="M14 3h7v7h-2V6.4l-9.3 9.3-1.4-1.4L17.6 5H14V3z"/>
                  </svg>
                </div>
              </a>
            <% }) %>
          </div>
        </div>

        <!-- ACTIONS (not sticking) -->
        <div class="detail-actions" style="margin-top:16px; gap:12px;">
          <% if (panelConfig?.telegramAdminUrl) { %>
            <a class="pill glass-btn"
               href="<%= panelConfig.telegramAdminUrl %>"
               target="_blank" rel="noopener">
              üí¨ Contact Admin
            </a>
          <% } %>

          <% if (panelConfig?.telegramChannelUrl) { %>
            <a class="pill glass-btn"
               href="<%= panelConfig.telegramChannelUrl %>"
               target="_blank" rel="noopener">
              üì¢ Join Channel
            </a>
          <% } %>
        </div>

      </section>

      <footer class="footer">
        ¬© <%= new Date().getFullYear() %> <%= panelConfig?.brandName || "N4 VPN" %>
      </footer>

    <% } %>

  </main>
</div>

<script>
function copyKey(){
  const el = document.getElementById("keyInput");
  if(!el) return;

  // Modern copy when available
  const v = el.value || "";
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(v).catch(()=>{});
    return;
  }

  // Fallback
  el.focus();
  el.select();
  el.setSelectionRange(0, 999999);
  try { document.execCommand("copy"); } catch(e) {}
}
</script>

</body>
</html>
