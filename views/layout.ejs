<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />

  <title><%= title ? title + " ‚Ä¢ " : "" %><%= (panelConfig && panelConfig.brandName) ? panelConfig.brandName : "FREE KEY By N4" %></title>

  <!-- CSS Architecture (must be /public/...) -->
  <link rel="stylesheet" href="/public/00-tokens.css" />
  <link rel="stylesheet" href="/public/01-base.css" />
  <link rel="stylesheet" href="/public/02-layout.css" />
  <link rel="stylesheet" href="/public/03-components.css" />
  <link rel="stylesheet" href="/public/04-pages.css" />
  <link rel="stylesheet" href="/public/05-utilities.css" />
</head>

<body class="theme-light">
  <div class="bg-aurora" aria-hidden="true"></div>

  <!-- Sticky Header -->
  <header class="app-header">
    <div class="container header-inner">
      <div class="brand">
        <div class="brand-icon" aria-hidden="true">‚ö°</div>
        <div class="brand-text">
          <div class="brand-title"><%= (panelConfig && panelConfig.brandName) ? panelConfig.brandName : "FREE KEY By N4" %></div>
          <div class="brand-sub">Fast ‚Ä¢ Simple ‚Ä¢ Secure</div>
        </div>
      </div>

      <div class="header-actions">
        <% if (panelConfig && panelConfig.channelUrl) { %>
          <a class="btn btn-ghost btn-pill" href="<%= panelConfig.channelUrl %>" target="_blank" rel="noopener">
            ‚úàÔ∏è <span>Channel</span>
          </a>
        <% } %>
      </div>
    </div>
  </header>

  <main class="app-main">
    <div class="container">
      <%- content %>
    </div>
  </main>

  <footer class="app-footer">
    <div class="container footer-inner">
      <div class="muted">
        ¬© <%= new Date().getFullYear() %> <%= (panelConfig && panelConfig.brandName) ? panelConfig.brandName : "FREE KEY By N4" %>
      </div>

      <% if (panelConfig && panelConfig.footerLinkText && panelConfig.footerLinkUrl) { %>
        <a class="footer-link" href="<%= panelConfig.footerLinkUrl %>" target="_blank" rel="noopener"><%= panelConfig.footerLinkText %></a>
      <% } %>
    </div>
  </footer>

  <!-- Announcement Modal (User page) -->
  <% if (panelConfig && panelConfig.announcement) { %>
    <div class="modal" id="announceModal" aria-hidden="true">
      <div class="modal-backdrop" data-close="1"></div>

      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="announceTitle">
        <div class="modal-head">
          <div class="modal-title" id="announceTitle">üì£ Announcement</div>
          <button class="icon-btn" type="button" data-close="1" aria-label="Close">‚úï</button>
        </div>

        <div class="modal-body rich">
          <!-- Admin ·ÄÄ HTML/emoji/photo/link ·Äê·ÄΩ·Ä±·Äë·Ää·Ä∑·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Äú·Ä≠·ÄØ·Ä∑ raw HTML ·Äë·ÄØ·Äê·Ä∫·Äï·Äº·Äë·Ä¨·Ä∏·Äê·Äö·Ä∫ -->
          <%- panelConfig.announcement %>
        </div>

        <div class="modal-foot">
          <button class="btn btn-primary btn-pill" type="button" data-close="1">Close</button>
        </div>
      </div>
    </div>
  <% } %>

  <script>
    (function () {
      // Announcement show once per content (hash)
      const modal = document.getElementById("announceModal");
      if (!modal) return;

      const raw = <%- JSON.stringify(String(panelConfig.announcement || "")) %>;
      const key = "n4_announcement_hash";
      const shownKey = "n4_announcement_dismissed";

      function hashStr(str) {
        // lightweight hash
        let h = 0, i = 0;
        while (i < str.length) { h = (h << 5) - h + str.charCodeAt(i++) | 0; }
        return String(h);
      }

      const currentHash = hashStr(raw);
      const lastHash = localStorage.getItem(key);
      const dismissed = localStorage.getItem(shownKey);

      function open() {
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
        document.documentElement.classList.add("modal-open");
      }
      function close() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
        document.documentElement.classList.remove("modal-open");
        localStorage.setItem(key, currentHash);
        localStorage.setItem(shownKey, "1");
      }

      // only show when announcement changed OR not dismissed before
      const shouldShow = (lastHash !== currentHash) || (dismissed !== "1");
      if (shouldShow && raw.trim().length) {
        open();
      }

      modal.addEventListener("click", (e) => {
        const t = e.target;
        if (t && t.getAttribute && t.getAttribute("data-close") === "1") close();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("is-open")) close();
      });
    })();
  </script>
</body>
</html>
