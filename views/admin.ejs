<%- include("layout", {
  title: "Admin",
  panelConfig,
  body: `
  <section class="section">
    <div class="glass adminWrap">

      ${mode === "login" ? `
        <div class="adminHead">
          <div class="adminTitle">Admin Login</div>
          <div class="adminSub">Hidden path ·ÄÄ·Ä≠·ÄØ ·Äû·Ä≠·Äê·Ä≤·Ä∑·Äû·Ä∞·Äï·Ä≤ ·Äù·ÄÑ·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã</div>
        </div>

        ${error ? `<div class="alert bad">${error}</div>` : ""}

        <form class="adminLogin" method="POST" action="/${adminPath}/login">
          <div class="field">
            <label class="label">Password</label>
            <input class="input" type="password" name="password" placeholder="Enter admin password" required />
          </div>
          <button class="btn primary" type="submit"><span class="btnIcon">üîê</span> Login</button>
        </form>
      ` : `
        <div class="adminHead row">
          <div>
            <div class="adminTitle">Admin Dashboard</div>
            <div class="adminSub">VPN Key ·Äê·ÄΩ·Ä± ·Äë·Ää·Ä∑·Ä∫/·Äñ·Äª·ÄÄ·Ä∫/·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Ä≠·Äê·Ä∫ + Announcement ·Äê·ÄÑ·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã</div>
          </div>

          <form method="POST" action="/${adminPath}/logout">
            <button class="btn ghost" type="submit"><span class="btnIcon">‚Ü©</span> Logout</button>
          </form>
        </div>

        <div class="glass adminCard">
          <div class="cardTitle">Site Announcement (Markdown)</div>

          <form class="adminForm" method="POST" action="/${adminPath}/announce">
            <div class="field">
              <label class="label">Enable</label>
              <select class="select" name="announce_enabled">
                <option value="0" ${announceEnabled ? "" : "selected"}>OFF</option>
                <option value="1" ${announceEnabled ? "selected" : ""}>ON</option>
              </select>
            </div>

            <div class="field">
              <label class="label">Message (supports emoji, links, images)</label>
              <textarea class="input mono" name="announce_md" rows="8" placeholder="Example:
# üî• New Update
‚úÖ Free keys available
üëâ [Join Channel](https://t.me/xxx)
![banner](https://i.imgur.com/xxxx.png)
">${(announceMd || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea>

              <div class="hint">
                Markdown support: <span class="kbd"># title</span>, <span class="kbd">**bold**</span>, <span class="kbd">[link](url)</span>, <span class="kbd">![img](https://...)</span>
              </div>
            </div>

            <button class="btn primary" type="submit"><span class="btnIcon">üíæ</span> Save Announcement</button>
          </form>
        </div>

        <div class="glass adminCard">
          <div class="cardTitle">Add VPN Key</div>

          <form class="adminForm" method="POST" action="/${adminPath}/add">
            <div class="formGrid">
              <div class="field">
                <label class="label">Key Type</label>
                <select class="select" name="type">
                  <option value="V2RAY">V2RAY</option>
                  <option value="OUTLINE">OUTLINE</option>
                  <option value="SS">SS</option>
                  <option value="VLESS">VLESS</option>
                </select>
              </div>

              <div class="field">
                <label class="label">Status</label>
                <select class="select" name="status">
                  <option value="ACTIVE">ACTIVE</option>
                  <option value="INACTIVE">INACTIVE</option>
                </select>
              </div>

              <div class="field">
                <label class="label">GB Limit</label>
                <input class="input" name="gb_limit" inputmode="numeric" value="${defaults.gb_limit}" />
              </div>

              <div class="field">
                <label class="label">Expire Date</label>
                <input class="input" name="expire_date" placeholder="YYYY-MM-DD" value="${defaults.expire_date}" />
              </div>

              <div class="field">
                <label class="label">Region Name</label>
                <input class="input" name="region_name" placeholder="Singapore" value="${defaults.region_name}" required />
              </div>

              <div class="field">
                <label class="label">Region Flag (emoji)</label>
                <input class="input" name="region_flag" placeholder="üá∏üá¨" value="${defaults.region_flag}" />
              </div>

              <div class="field full">
                <label class="label">Key String</label>
                <textarea class="input mono" name="key_string" rows="3" placeholder="ss://...  or  vless://...  or  vmess://..." required></textarea>
              </div>
            </div>

            <button class="btn primary" type="submit"><span class="btnIcon">‚ûï</span> Add Key</button>
          </form>
        </div>

        <div class="glass adminCard">
          <div class="cardTitle">Keys</div>

          <div class="tableWrap">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Type</th>
                  <th>Region</th>
                  <th>GB</th>
                  <th>Expire</th>
                  <th>Status</th>
                  <th>Link</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${keys.map(k => `
                  <tr>
                    <td>${k.id}</td>
                    <td>${k.type}</td>
                    <td><span class="flag">${k.region_flag || "üåê"}</span> ${k.region_name}</td>
                    <td>${k.gb_limit || ""}</td>
                    <td>${k.expire_date || ""}</td>
                    <td>
                      <span class="badge ${k.statusComputed === "ACTIVE" ? "ok" : (k.statusComputed === "EXPIRED" ? "bad" : "muted")}">
                        ${k.statusComputed}
                      </span>
                    </td>
                    <td><a class="link" href="${k.link}" target="_blank" rel="noopener">/k/${k.id}</a></td>
                    <td class="actions">
                      <form method="POST" action="/${adminPath}/toggle/${k.id}">
                        <button class="btn tiny" type="submit">${(k.status || "ACTIVE").toUpperCase() === "ACTIVE" ? "Disable" : "Enable"}</button>
                      </form>
                      <form method="POST" action="/${adminPath}/delete/${k.id}" onsubmit="return confirm('Delete this key?')">
                        <button class="btn tiny danger" type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
      `}
    </div>
  </section>
  `
}) %>
